<!DOCTYPE html><html lang="en"><head>&lt;!--  --&gt;<meta charset="utf-8"/><meta author="David Wilson"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="stylesheet" href="/css/bootstrap.min.css"/><link rel="stylesheet" href="/fonts/iosevka-aile/iosevka-aile.css"/><link rel="stylesheet" href="/fonts/jetbrains-mono/jetbrains-mono.css"/><link rel="stylesheet" href="/css/code.css"/><link rel="stylesheet" href="/css/site.css"/><script defer="defer" data-domain="wiki.systemcrafters.net" src="https://plausible.io/js/plausible.js"></script><title>EXWM Hacking Notes - System Crafters</title></head><body>&lt;div&gt;&lt;div class=&quot;blog-header&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row align-items-center justify-content-between&quot;&gt;&lt;div class=&quot;col-sm-12 col-md-8&quot;&gt;&lt;div class=&quot;blog-title&quot;&gt;System Crafters&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;col-sm col-md&quot;&gt;&lt;div class=&quot;blog-description text-sm-left text-md-right text-lg-right text-xl-right&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;blog-masthead&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row align-items-center justify-content-between&quot;&gt;&lt;div class=&quot;col-sm-12 col-md-12&quot;&gt;&lt;nav class=&quot;nav&quot;&gt;&lt;a class=&quot;nav-link&quot; href=&quot;/&quot;&gt;Main Page&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;/emacs&quot;&gt;GNU Emacs&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;/guix&quot;&gt;GNU Guix&lt;/a&gt;&lt;a class=&quot;nav-link&quot; href=&quot;https://systemcrafters.net&quot;&gt;System Crafters Home&lt;/a&gt;&lt;form class=&quot;navbar-form navbar-right&quot; role=&quot;search&quot; action=&quot;https://duckduckgo.com/&quot;&gt;&lt;div class=&quot;form-group&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;q&quot; class=&quot;form-control&quot; placeholder=&quot;Search Wiki&quot; style=&quot;overflow: hidden;margin-top: 3%;margin-bottom: 2%;&quot;/&gt;&lt;input type=&quot;hidden&quot; name=&quot;sites&quot; value=&quot;wiki.systemcrafters.net&quot;/&gt;&lt;/div&gt;&lt;/form&gt; &lt;/nav&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<div class="container"><div class="row"><div class="col-sm-12 blog-main"><div class="blog-post"><h1 class="blog-post-title">EXWM Hacking Notes</h1><p class="blog-post-meta"></p>&lt;div&gt;&lt;p&gt;This is a set of notes that are being compiled as a part of the &lt;a href=&quot;https://youtube.com/playlist?list=PLEoMzSkcN8oOS1y2uMspTXr1nd5JxUSzB&quot;&gt;Hack Sessions&lt;/a&gt; series of streams!
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;tasks&quot; class=&quot;anchor&quot; href=&quot;#tasks&quot;&gt;¶&lt;/a&gt;Tasks&lt;/h2&gt;&lt;h3&gt;&lt;a id=&quot;find-a-good-exwm-bug-to-investigate-for-next-time&quot; class=&quot;anchor&quot; href=&quot;#find-a-good-exwm-bug-to-investigate-for-next-time&quot;&gt;¶&lt;/a&gt;Find a good EXWM bug to investigate for next time&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/ch11ng/exwm/issues/847&quot;&gt;https://github.com/ch11ng/exwm/issues/847&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;h2&gt;&lt;a id=&quot;repository-links&quot; class=&quot;anchor&quot; href=&quot;#repository-links&quot;&gt;¶&lt;/a&gt;Repository Links&lt;/h2&gt;&lt;p&gt;Here are the official EXWM repo links:
&lt;/p&gt;

&lt;ul&gt;&lt;li&gt;&lt;a href=&quot;https://github.com/ch11ng/exwm/&quot;&gt;https://github.com/ch11ng/exwm/&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;https://github.com/ch11ng/xelb&quot;&gt;https://github.com/ch11ng/xelb&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;FAQ (helpful for debugging): &lt;a href=&quot;https://github.com/ch11ng/exwm/wiki#faq&quot;&gt;https://github.com/ch11ng/exwm/wiki#faq&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;

&lt;p&gt;If you&apos;d like to contribute to my fork, you can check it out here:
&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://github.com/daviwil/exwm&quot;&gt;https://github.com/daviwil/exwm&lt;/a&gt;
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;exwm-overview&quot; class=&quot;anchor&quot; href=&quot;#exwm-overview&quot;&gt;¶&lt;/a&gt;EXWM Overview&lt;/h2&gt;&lt;p&gt;The files:
&lt;/p&gt;

&lt;h3&gt;&lt;a id=&quot;exwmel&quot; class=&quot;anchor&quot; href=&quot;#exwmel&quot;&gt;¶&lt;/a&gt;exwm.el&lt;/h3&gt;&lt;p&gt;&lt;kbd&gt;exwm-init&lt;/kbd&gt; is the entrypoint for setting up EXWM and connecting to the X Window System server.
&lt;/p&gt;

&lt;p&gt;Many update functions used internally
&lt;/p&gt;

&lt;p&gt;Part of the initialization process is to initialize modules like ICCCM and EWMH via functions like &lt;kbd&gt;xcb:ewmh:init&lt;/kbd&gt;, these seem to be focused around fetching the IDs for well-known Atoms.  Once they&apos;ve been fetched, those subsystems are considered to be initialized.
&lt;/p&gt;

&lt;h3&gt;&lt;a id=&quot;other-files&quot; class=&quot;anchor&quot; href=&quot;#other-files&quot;&gt;¶&lt;/a&gt;Other files&lt;/h3&gt;&lt;p&gt;BUG_HUNT.org
README.md
exwm-cm.el
exwm-config.el
exwm-core.el
exwm-floating.el
exwm-input.el
exwm-layout.el
exwm-manage.el
exwm-randr.el
exwm-systemtray.el
exwm-workspace.el
exwm-xim.el
xinitrc
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;xelb-overview&quot; class=&quot;anchor&quot; href=&quot;#xelb-overview&quot;&gt;¶&lt;/a&gt;XELB Overview&lt;/h2&gt;&lt;p&gt;Generates elisp libraries for the X11 protocol with the &lt;kbd&gt;el_client.el&lt;/kbd&gt; file, driven by the &lt;kbd&gt;Makefile&lt;/kbd&gt;
&lt;/p&gt;

&lt;p&gt;A small portion of the files are generated but many are helper libraries for specific parts of the X11 protocol.
&lt;/p&gt;


&lt;h2&gt;&lt;a id=&quot;definitions&quot; class=&quot;anchor&quot; href=&quot;#definitions&quot;&gt;¶&lt;/a&gt;Definitions&lt;/h2&gt;&lt;h3&gt;&lt;a id=&quot;xcb&quot; class=&quot;anchor&quot; href=&quot;#xcb&quot;&gt;¶&lt;/a&gt;xcb&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://xcb.freedesktop.org/&quot;&gt;https://xcb.freedesktop.org/&lt;/a&gt;
&lt;a href=&quot;https://xcb.freedesktop.org/tutorial/&quot;&gt;xcb tutorial&lt;/a&gt;
&lt;a href=&quot;https://xcb.freedesktop.org/XmlXcb/&quot;&gt;XML-XCB format for describing the X Window System protocol&lt;/a&gt;
&lt;/p&gt;

&lt;h3&gt;&lt;a id=&quot;x-window-system&quot; class=&quot;anchor&quot; href=&quot;#x-window-system&quot;&gt;¶&lt;/a&gt;X Window System&lt;/h3&gt;&lt;p&gt;This is the client/server system which handles drawing to the screen, mouse/keyboard input, etc.
&lt;/p&gt;

&lt;p&gt;You communicate with it via an XML-based protocol.
&lt;/p&gt;

&lt;h3&gt;&lt;a id=&quot;icccm&quot; class=&quot;anchor&quot; href=&quot;#icccm&quot;&gt;¶&lt;/a&gt;ICCCM&lt;/h3&gt;&lt;p&gt;This seems to be a set of conventions for commuication between clients in the X Window System
&lt;/p&gt;

&lt;p&gt;Describes window manager interactions at a low level
&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://www.x.org/releases/current/doc/xorg-docs/icccm/icccm.html#Introduction&quot;&gt;https://www.x.org/releases/current/doc/xorg-docs/icccm/icccm.html#Introduction&lt;/a&gt;
&lt;/p&gt;

&lt;h3&gt;&lt;a id=&quot;ewmh&quot; class=&quot;anchor&quot; href=&quot;#ewmh&quot;&gt;¶&lt;/a&gt;EWMH&lt;/h3&gt;&lt;p&gt;Extended Window Manager Hints
&lt;/p&gt;

&lt;p&gt;An extended set of conventions for modern desktop environments (see Non-ICCCM features section)
&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;https://specifications.freedesktop.org/wm-spec/wm-spec-1.3.html&quot;&gt;https://specifications.freedesktop.org/wm-spec/wm-spec-1.3.html&lt;/a&gt;
&lt;/p&gt;

&lt;p&gt;Assumption: the window manager is the &quot;root window&quot; and anything in this document that describes messages handled by the root window are actually handled by the window manager.
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;testing-with-xephyr&quot; class=&quot;anchor&quot; href=&quot;#testing-with-xephyr&quot;&gt;¶&lt;/a&gt;Testing with Xephyr&lt;/h2&gt;&lt;p&gt;Docs: &lt;a href=&quot;https://cgit.freedesktop.org/xorg/xserver/tree/hw/kdrive/ephyr/README&quot;&gt;https://cgit.freedesktop.org/xorg/xserver/tree/hw/kdrive/ephyr/README&lt;/a&gt;
&lt;/p&gt;

&lt;p&gt;Here&apos;s a simple script that can help with testing:
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;sh&quot;&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;#&lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;!/bin/sh&lt;/span&gt;
Xephyr :1 -ac -dpi 180 -screen 1920x1080 &amp;amp;
&lt;span class=&quot;org-variable-name&quot;&gt;DISPLAY&lt;/span&gt;=:1 emacs
pkill Xephyr

&lt;/code&gt;&lt;/pre&gt;

&lt;p&gt;I&apos;m also using this Emacs configuration for testing purposes:
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;
(add-to-list &apos;load-path (expand-file-name &lt;span class=&quot;org-string&quot;&gt;&quot;/home/daviwil/Projects/Code/xelb&quot;&lt;/span&gt;))
(add-to-list &apos;load-path (expand-file-name &lt;span class=&quot;org-string&quot;&gt;&quot;/home/daviwil/Projects/Code/exwm&quot;&lt;/span&gt;))

(load-theme &apos;deeper-blue t)

(&lt;span class=&quot;org-keyword&quot;&gt;require&lt;/span&gt; &apos;&lt;span class=&quot;org-constant&quot;&gt;exwm&lt;/span&gt;)

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Allow C+lmb to move windows&lt;/span&gt;
(&lt;span class=&quot;org-keyword&quot;&gt;setq&lt;/span&gt; exwm-input-move-event &apos;C-down-mouse-1)

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Set some global keys&lt;/span&gt;
(&lt;span class=&quot;org-keyword&quot;&gt;setq&lt;/span&gt; exwm-input-global-keys
      `(([?\C-c ?x ?r] . exwm-reset)
        ([?\C-c ?x ?i] . exwm-input-toggle-keyboard)
        ([?\C-c ?x ?f] . exwm-layout-toggle-fullscreen)
        ([?\C-c ?x ?l] . (&lt;span class=&quot;org-keyword&quot;&gt;lambda&lt;/span&gt; (command)
                           (&lt;span class=&quot;org-keyword&quot;&gt;interactive&lt;/span&gt; (list (read-shell-command &lt;span class=&quot;org-string&quot;&gt;&quot;$ &quot;&lt;/span&gt;)))
                           (start-process-shell-command command nil command)))
        ([?\C-c ?x ?k] . (&lt;span class=&quot;org-keyword&quot;&gt;lambda&lt;/span&gt; () (&lt;span class=&quot;org-keyword&quot;&gt;interactive&lt;/span&gt;) (kill-buffer)))
        ,@(mapcar (&lt;span class=&quot;org-keyword&quot;&gt;lambda&lt;/span&gt; (i)
                    `(,(kbd (format &lt;span class=&quot;org-string&quot;&gt;&quot;C-c x %d&quot;&lt;/span&gt; i)) .
                      (&lt;span class=&quot;org-keyword&quot;&gt;lambda&lt;/span&gt; ()
                        (&lt;span class=&quot;org-keyword&quot;&gt;interactive&lt;/span&gt;)
                        (exwm-workspace-switch-create ,i))))
                  (number-sequence 0 9))))

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Initialize EXWM&lt;/span&gt;
(exwm-init)

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Turn EXWM and XELB logging (check *XELB-DEBUG* buffer)&lt;/span&gt;
(exwm-debug)

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Enter the debugger when an error is encountered&lt;/span&gt;
(toggle-debug-on-error)

(&lt;span class=&quot;org-keyword&quot;&gt;defun&lt;/span&gt; &lt;span class=&quot;org-function-name&quot;&gt;dw/exwm-fake-command-wrapper&lt;/span&gt; (orig-fn &lt;span class=&quot;org-type&quot;&gt;&amp;amp;rest&lt;/span&gt; args)
  (debug-on-variable-change &apos;last-command)
  (apply orig-fn args)
  (cancel-debug-on-variable-change &apos;last-command))

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;NOTE: This isn&apos;t being used now, leaving it here for reference&lt;/span&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;(advice-add &apos;exwm-input--fake-last-command :around #&apos;dw/exwm-fake-command-wrapper)&lt;/span&gt;

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Kudos to Timor for this suggestion:&lt;/span&gt;
(&lt;span class=&quot;org-keyword&quot;&gt;defun&lt;/span&gt; &lt;span class=&quot;org-function-name&quot;&gt;xcb-debug:message&lt;/span&gt; (format-string &lt;span class=&quot;org-type&quot;&gt;&amp;amp;rest&lt;/span&gt; objects)
  &lt;span class=&quot;org-doc&quot;&gt;&quot;Print a message to `&lt;/span&gt;&lt;span class=&quot;org-doc&quot;&gt;&lt;span class=&quot;org-constant&quot;&gt;xcb-debug:buffer&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;org-doc&quot;&gt;&apos;.&lt;/span&gt;

&lt;span class=&quot;org-doc&quot;&gt;The FORMAT-STRING argument follows the speficies how to print each of&lt;/span&gt;
&lt;span class=&quot;org-doc&quot;&gt;the passed OBJECTS.  See `&lt;/span&gt;&lt;span class=&quot;org-doc&quot;&gt;&lt;span class=&quot;org-constant&quot;&gt;format&lt;/span&gt;&lt;/span&gt;&lt;span class=&quot;org-doc&quot;&gt;&apos; for details.&quot;&lt;/span&gt;
  (&lt;span class=&quot;org-keyword&quot;&gt;let&lt;/span&gt; ((str (apply #&apos;format format-string objects)))
    (xcb-debug:-with-debug-buffer
     (insert str))
    (princ str &apos;external-debugging-output)))

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;NOTE: To save logs to a file, use:&lt;/span&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;;&lt;/span&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;;    &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;emacs 2&amp;gt;exwm.log&lt;/span&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;;&lt;/span&gt;

&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;Log each window that get opened&lt;/span&gt;
(add-hook &apos;exwm-manage-finish-hook
          (&lt;span class=&quot;org-keyword&quot;&gt;lambda&lt;/span&gt; ()
            (exwm--log &lt;span class=&quot;org-string&quot;&gt;&quot;WINDOW DISPLAYED: %s (%s)&quot;&lt;/span&gt; exwm-class-name exwm-title)))

(split-window-right)
(other-window 1)
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;(start-process-shell-command &quot;gnome-mahjongg&quot; nil &quot;gnome-mahjongg&quot;)&lt;/span&gt;
&lt;span class=&quot;org-comment-delimiter&quot;&gt;;; &lt;/span&gt;&lt;span class=&quot;org-comment&quot;&gt;(start-process-shell-command &quot;calibre&quot; nil &quot;calibre&quot;)&lt;/span&gt;

&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;&lt;a id=&quot;bug-investigations&quot; class=&quot;anchor&quot; href=&quot;#bug-investigations&quot;&gt;¶&lt;/a&gt;Bug Investigations&lt;/h2&gt;&lt;h3&gt;&lt;a id=&quot;fixed---842-hang-when-clicking-on-x-window-after-isearch&quot; class=&quot;anchor&quot; href=&quot;#fixed---842-hang-when-clicking-on-x-window-after-isearch&quot;&gt;¶&lt;/a&gt;FIXED - #842: Hang when clicking on X window after isearch&lt;/h3&gt;&lt;p&gt;Link: &lt;a href=&quot;https://github.com/ch11ng/exwm/issues/842&quot;&gt;https://github.com/ch11ng/exwm/issues/842&lt;/a&gt;
&lt;/p&gt;

&lt;p&gt;&lt;strong&gt;Notes&lt;/strong&gt;
&lt;/p&gt;

&lt;p&gt;This was caused by a misbehaving function in &lt;kbd&gt;isearch&lt;/kbd&gt; which was being added to the &lt;kbd&gt;pre-command-hook&lt;/kbd&gt; that gets invoked by &lt;kbd&gt;exwm-input--fake-last-command&lt;/kbd&gt;.  We fixed the issue by wrapping the &lt;kbd&gt;run-hooks&lt;/kbd&gt; calls with a &lt;kbd&gt;condition-case&lt;/kbd&gt; macro to prevent errors from breaking the EXWM session.
&lt;/p&gt;

&lt;h3&gt;&lt;a id=&quot;backlog&quot; class=&quot;anchor&quot; href=&quot;#backlog&quot;&gt;¶&lt;/a&gt;Backlog&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;monitor size issues: &lt;a href=&quot;https://github.com/ch11ng/exwm/issues/847&quot;&gt;https://github.com/ch11ng/exwm/issues/847&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;closed windows process not being killed: &lt;a href=&quot;https://github.com/ch11ng/exwm/issues/844&quot;&gt;https://github.com/ch11ng/exwm/issues/844&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</div></div></div></div>&lt;footer class=&quot;blog-footer&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row&quot;&gt;&lt;div class=&quot;col-sm col-md text-sm-left text-md-right text-lg-right text-xl-right&quot;&gt;&lt;p&gt;Made with Emacs 27.2 (Org mode 9.4.4)&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://systemcrafters.net/privacy-policy/&quot;&gt;Privacy Policy&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/footer&gt;&lt;script src=&quot;/js/bootstrap.bundle.min.js&quot;/&gt;</body></html>

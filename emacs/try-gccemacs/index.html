<!DOCTYPE html><html lang="en"><head>&lt;!--  --&gt;<meta charset="utf-8"/><meta author="David Wilson"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><link rel="stylesheet" href="/css/bootstrap.min.css"/><link rel="stylesheet" href="/fonts/iosevka-aile/iosevka-aile.css"/><link rel="stylesheet" href="/fonts/jetbrains-mono/jetbrains-mono.css"/><link rel="stylesheet" href="/css/code.css"/><link rel="stylesheet" href="/css/site.css"/><script defer="defer" data-domain="wiki.systemcrafters.net" src="https://plausible.io/js/plausible.js"></script><title> - System Crafters</title></head><body>&lt;div&gt;&lt;div class=&quot;blog-header&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row align-items-center justify-content-between&quot;&gt;&lt;div class=&quot;col-sm-12 col-md-8&quot;&gt;&lt;div class=&quot;blog-title&quot;&gt;System Crafters&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;col-sm col-md&quot;&gt;&lt;div class=&quot;blog-description text-sm-left text-md-right text-lg-right text-xl-right&quot;&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;div class=&quot;blog-masthead&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row align-items-center justify-content-between&quot;&gt;&lt;div class=&quot;col-sm-12 col-md-12&quot;&gt;&lt;nav class=&quot;nav&quot;&gt;&lt;a class=&quot;nav-link&quot; href=&quot;/&quot;&gt;Main Page&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;/emacs&quot;&gt;GNU Emacs&lt;/a&gt; &lt;a class=&quot;nav-link&quot; href=&quot;/guix&quot;&gt;GNU Guix&lt;/a&gt;&lt;a class=&quot;nav-link&quot; href=&quot;https://systemcrafters.net&quot;&gt;System Crafters Home&lt;/a&gt;&lt;form class=&quot;navbar-form navbar-right&quot; role=&quot;search&quot; action=&quot;https://duckduckgo.com/&quot;&gt;&lt;div class=&quot;form-group&quot;&gt;&lt;input type=&quot;text&quot; name=&quot;q&quot; class=&quot;form-control&quot; placeholder=&quot;Search Wiki&quot; style=&quot;overflow: hidden;margin-top: 3%;margin-bottom: 2%;&quot;/&gt;&lt;input type=&quot;hidden&quot; name=&quot;sites&quot; value=&quot;wiki.systemcrafters.net&quot;/&gt;&lt;/div&gt;&lt;/form&gt; &lt;/nav&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;<div class="container"><div class="row"><div class="col-sm-12 blog-main"><div class="blog-post"><h1 class="blog-post-title"></h1><p class="blog-post-meta"></p>&lt;div&gt;&lt;p&gt;In this article we will see various steps to test/try &lt;kbd&gt;emacs-28&lt;/kbd&gt; with native compilation support on &lt;kbd&gt;Ubuntu 20.04LTS&lt;/kbd&gt;. We will not touch existing emacs installed using &lt;kbd&gt;apt&lt;/kbd&gt; on the Ubuntu, but will manually compile another version of &lt;kbd&gt;emacs-28&lt;/kbd&gt; with &lt;kbd&gt;native-compilation&lt;/kbd&gt; support (called &lt;kbd&gt;gccemacs&lt;/kbd&gt; henceforth) in the &lt;kbd&gt;~/opt/emacs-native&lt;/kbd&gt; folder. These two versions of emacs (already installed and &lt;kbd&gt;gccemacs&lt;/kbd&gt;) will use different config files (&lt;kbd&gt;init.el&lt;/kbd&gt;) and user-directories (&lt;kbd&gt;~/.emacs.d&lt;/kbd&gt;) using &lt;kbd&gt;chemacs2&lt;/kbd&gt;, so that they don&apos;t interfere with each other. Using this approach users can try &lt;kbd&gt;gccemacs&lt;/kbd&gt; without breaking their stable emacs config.
&lt;/p&gt;

&lt;p&gt;Please help us improving this wiki by reporting any bugs/issues in the wiki github repo. 
&lt;/p&gt;

&lt;h2&gt;&lt;a id=&quot;installing-gccemacs&quot; class=&quot;anchor&quot; href=&quot;#installing-gccemacs&quot;&gt;¶&lt;/a&gt;Installing gccemacs&lt;/h2&gt;&lt;p&gt;check for any errors during &lt;kbd&gt;./configure&lt;/kbd&gt; step, you may be missing some libraries, which need to be installed using &lt;kbd&gt;apt&lt;/kbd&gt;.
&lt;/p&gt;

&lt;pre&gt;&lt;code class=&quot;shell&quot;&gt;mkdir -p ~/opt
mkdir -p ~/opt/emacs-native
&lt;span class=&quot;org-builtin&quot;&gt;cd&lt;/span&gt; ~/opt
sudo add-apt-repository ppa:ubuntu-toolchain-r/ppa
sudo apt install gcc-10 g++-10 libgccjit0 libgccjit-10-dev libjansson4 libjansson-dev
sudo apt install libxpm-dev libgif-dev libtiff-dev libgnutls28-dev libmagick++-dev
git clone git://git.sv.gnu.org/emacs.git gccemacs
&lt;span class=&quot;org-builtin&quot;&gt;cd&lt;/span&gt; gccemacs
git checkout master
&lt;span class=&quot;org-builtin&quot;&gt;export&lt;/span&gt; &lt;span class=&quot;org-variable-name&quot;&gt;CC&lt;/span&gt;=/usr/bin/gcc-10 &lt;span class=&quot;org-variable-name&quot;&gt;CXX&lt;/span&gt;=/usr/bin/gcc-10
./autogen.sh
./configure --with-cairo --with-modules --without-compress-install --with-x-toolkit=no --with-gnutls --without-gconf --without-xwidgets --without-toolkit-scroll-bars --without-xaw3d --without-gsettings --with-mailutils --with-native-compilation --with-json --with-harfbuzz --with-imagemagick --with-jpeg --with-png --with-rsvg --with-tiff --with-wide-int --with-xft --with-xml2 --with-xpm &lt;span class=&quot;org-variable-name&quot;&gt;CFLAGS&lt;/span&gt;=&lt;span class=&quot;org-string&quot;&gt;&quot;-O3 -mtune=native -march=native -fomit-frame-pointer&quot;&lt;/span&gt; &lt;span class=&quot;org-variable-name&quot;&gt;prefix&lt;/span&gt;=~/opt/emacs-native
make -j2 &lt;span class=&quot;org-variable-name&quot;&gt;NATIVE_FULL_AOT&lt;/span&gt;=1
make install
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;&lt;a id=&quot;using-emacs-profiles&quot; class=&quot;anchor&quot; href=&quot;#using-emacs-profiles&quot;&gt;¶&lt;/a&gt;Using emacs-profiles&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;Install &lt;a href=&quot;https://github.com/plexus/chemacs2&quot;&gt;chemacs2&lt;/a&gt; using following script&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;shell&quot;&gt;[ -f ~/.emacs ] &amp;amp;&amp;amp; mv ~/.emacs ~/.emacs.bak
[ -d ~/.emacs.d ] &amp;amp;&amp;amp; mv ~/.emacs.d ~/.emacs.default
git clone https://github.com/plexus/chemacs2.git ~/.emacs.d
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;&lt;li&gt;save following in &lt;kbd&gt;~/.emacs-profile.el&lt;/kbd&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;(
 (&lt;span class=&quot;org-string&quot;&gt;&quot;default&quot;&lt;/span&gt; . ((user-emacs-directory . &lt;span class=&quot;org-string&quot;&gt;&quot;~/.emacs.default&quot;&lt;/span&gt;)
  (server-name . &lt;span class=&quot;org-string&quot;&gt;&quot;default-server&quot;&lt;/span&gt;)))
 (&lt;span class=&quot;org-string&quot;&gt;&quot;gccemacs&quot;&lt;/span&gt; . ((user-emacs-directory . &lt;span class=&quot;org-string&quot;&gt;&quot;~/.gccemacs.d&quot;&lt;/span&gt;)
  (server-name . &lt;span class=&quot;org-string&quot;&gt;&quot;gccemacs-server&quot;&lt;/span&gt;)))
)
&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;&lt;li&gt;copy your default config &lt;kbd&gt;init.el&lt;/kbd&gt; to gccemacs folder&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;shell&quot;&gt;mkdir -p ~/.gccemacs.d
cp ~/.emacs.default/init.el ~/.gccemacs.d/init.el
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;&lt;a id=&quot;some-changes-in-config-file-for-gccemacs&quot; class=&quot;anchor&quot; href=&quot;#some-changes-in-config-file-for-gccemacs&quot;&gt;¶&lt;/a&gt;Some changes in config file for gccemacs&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;You can add following lines in your new &lt;kbd&gt;init.el&lt;/kbd&gt;  (in the &lt;kbd&gt;~/.gccemacs.d&lt;/kbd&gt; folder)just to check if native-compilation and native json is working&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;(&lt;span class=&quot;org-keyword&quot;&gt;setq&lt;/span&gt; comp-deferred-compilation t)

(&lt;span class=&quot;org-keyword&quot;&gt;if&lt;/span&gt; (&lt;span class=&quot;org-keyword&quot;&gt;and&lt;/span&gt; (fboundp &apos;native-comp-available-p)
       (native-comp-available-p))
  (message &lt;span class=&quot;org-string&quot;&gt;&quot;Native compilation is available&quot;&lt;/span&gt;)
(message &lt;span class=&quot;org-string&quot;&gt;&quot;Native complation is *not* available&quot;&lt;/span&gt;))

(&lt;span class=&quot;org-keyword&quot;&gt;if&lt;/span&gt; (functionp &apos;json-serialize)
  (message &lt;span class=&quot;org-string&quot;&gt;&quot;Native JSON is available&quot;&lt;/span&gt;)
(message &lt;span class=&quot;org-string&quot;&gt;&quot;Native JSON is *not* available&quot;&lt;/span&gt;))

&lt;/code&gt;&lt;/pre&gt;

&lt;ul&gt;&lt;li&gt;&lt;kbd&gt;straight.el&lt;/kbd&gt; uses its own native compilation which can create some problems. You can switch off this using &lt;kbd&gt;:build (:not native-compile)&lt;/kbd&gt;, for e.g. in case of &lt;kbd&gt;doom-themes&lt;/kbd&gt;, one can use the following&lt;/li&gt;
&lt;/ul&gt;

&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;(&lt;span class=&quot;org-keyword&quot;&gt;use-package&lt;/span&gt; &lt;span class=&quot;org-constant&quot;&gt;doom-themes&lt;/span&gt;
  &lt;span class=&quot;org-builtin&quot;&gt;:straight&lt;/span&gt; &apos;(doom-themes &lt;span class=&quot;org-builtin&quot;&gt;:build&lt;/span&gt; (&lt;span class=&quot;org-builtin&quot;&gt;:not&lt;/span&gt; native-compile))
  &lt;span class=&quot;org-builtin&quot;&gt;:init&lt;/span&gt;
  (load-theme &apos;doom-nord t)
)
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;&lt;a id=&quot;running-parallel-emacs&quot; class=&quot;anchor&quot; href=&quot;#running-parallel-emacs&quot;&gt;¶&lt;/a&gt;Running parallel emacs&lt;/h2&gt;&lt;h3&gt;&lt;a id=&quot;default-emacs&quot; class=&quot;anchor&quot; href=&quot;#default-emacs&quot;&gt;¶&lt;/a&gt;default emacs&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;run emacs without daemon (It is better to run this if you are running emacs first time after making all changes using &lt;kbd&gt;chemacs2&lt;/kbd&gt;). Try it 2-3 times so that no error/installation is left.&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;emacs --with-profile=default
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;If you are emacs daemon user then following will work&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;shell&quot;&gt;emacs --with-profile=default --daemon
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;run a instance of daemon using (after previous step)&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;shell&quot;&gt;emacsclient -c -s /run/user/1000/emacs/default-server
&lt;/code&gt;&lt;/pre&gt;

&lt;h3&gt;&lt;a id=&quot;gccemacs&quot; class=&quot;anchor&quot; href=&quot;#gccemacs&quot;&gt;¶&lt;/a&gt;gccemacs&lt;/h3&gt;&lt;ul&gt;&lt;li&gt;run emacs without daemon (It is better to run this if you are running emacs first time after making all changes using &lt;kbd&gt;chemacs2&lt;/kbd&gt;). Try it 2-3 times so that no error/installtion is left.&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;emacs-lisp&quot;&gt;~/opt/emacs-native/bin/emacs --with-profile=gccemacs
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;If you are emacs daemon user then following will work&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;shell&quot;&gt;~/opt/emacs-native/bin/emacs --with-profile=gccemacs --daemon
&lt;/code&gt;&lt;/pre&gt;
&lt;ul&gt;&lt;li&gt;run a instance of daemon using (after previous step)&lt;/li&gt;
&lt;/ul&gt;
&lt;pre&gt;&lt;code class=&quot;shell&quot;&gt;~/opt/emacs-native/bin/emacsclient -c -s /run/user/1000/emacs/gccemacs-server
&lt;/code&gt;&lt;/pre&gt;

&lt;h2&gt;&lt;a id=&quot;issuesbugs-and-the-solutions&quot; class=&quot;anchor&quot; href=&quot;#issuesbugs-and-the-solutions&quot;&gt;¶&lt;/a&gt;Issues/Bugs and the solutions&lt;/h2&gt;&lt;ul&gt;&lt;li&gt;Some packages like &lt;kbd&gt;vterm&lt;/kbd&gt;, &lt;kbd&gt;pdf-tools&lt;/kbd&gt; couldn&apos;t compile for first time, but after restarting the computer somehow, they are working fine.&lt;/li&gt;
&lt;li&gt;Many packages show lot of &lt;kbd&gt;warning&lt;/kbd&gt; messages. This happens when you are using these packages for first time. Shouldn&apos;t be a problem after that.&lt;/li&gt;
&lt;li&gt;Some user reported problem using &lt;kbd&gt;exwm&lt;/kbd&gt;, didn&apos;t try it yet.&lt;/li&gt;
&lt;/ul&gt;
&lt;/div&gt;</div></div></div></div>&lt;footer class=&quot;blog-footer&quot;&gt;&lt;div class=&quot;container&quot;&gt;&lt;div class=&quot;row&quot;&gt;&lt;div class=&quot;col-sm col-md text-sm-left text-md-right text-lg-right text-xl-right&quot;&gt;&lt;p&gt;Made with Emacs 27.2 (Org mode 9.4.4)&lt;/p&gt;&lt;p&gt;&lt;a href=&quot;https://systemcrafters.net/privacy-policy/&quot;&gt;Privacy Policy&lt;/a&gt;&lt;/p&gt;&lt;/div&gt;&lt;/div&gt;&lt;/div&gt;&lt;/footer&gt;&lt;script src=&quot;/js/bootstrap.bundle.min.js&quot;/&gt;</body></html>
